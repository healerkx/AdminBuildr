<script>
    $class('Dialog', null, {

        _domNode: null,

        showDialog: function(context, e) {
            var _thisDialog = this;
            var callback = function() {
                if (_thisDialog.save()) {
                    this.hide();
                }
            };

            var h = this.template;
            var href = '#' + h.replace('/', '_');
            var target = $(href && href.replace(/.*(?=#[^\s]+$)/, '')); //strip for ie7
            this._domNode = target;
            var option = $.extend({ remote: !/#/.test(href) && href }, {'onOk': callback});
            e && e.preventDefault();

            this.initVisible(context, target);
            target.modal(option);
        },

        initVisible: function (context, domNode) {
            var r = domNode;
            if (context.fieldMode == 'primaryKey') {
                selectOneValueOnly(r.find('td[field=hide_in_create] select'), 1);
                selectOneValueOnly(r.find('td[field=hide_in_update] select'), 1);
            }
        },

        getVisibility: function() {
            var tr = this._domNode.find('tr.visible');
            // console.log(tr);
            var hideInList = tr.find('td[field=hide_in_list] select').val();
            var hideInCreate = tr.find('td[field=hide_in_create] select').val();
            var hideInUpdate = tr.find('td[field=hide_in_update] select').val();
            var hideInDetail = tr.find('td[field=hide_in_detail] select').val();
            return {
                hideInList:hideInList,
                hideInCreate:hideInCreate,
                hideInUpdate:hideInUpdate,
                hideInDetail:hideInDetail
            };
        }
    });

    // Derived classes
    // ---------------
    $class('TextDialog', Dialog, {

        template:'abmodule/dialog-text',

        show: function (context, e) {
            // TODO: fill data into dom.
            this.showDialog(context, e);
        },

        save: function () {
            console.log("Save", this.getVisibility());
            return true;
        }
    });

    $class('SelectDialog', Dialog, {

        template:'abmodule/dialog-select',

        show: function (context, e) {
            // TODO: fill data into dom.
            var list = Widget.widgetById('entry-edit-list');
            console.log(list);
            if (list) {
                list.init();
            }
            this.showDialog(context, e);
        },

        save: function () {
            console.log("Save", this);
            return true;
        }
    });

    $class('RelatedIdDialog', Dialog, {
        template:'abmodule/dialog-fk',

        show: function (context, e) {
            // TODO: fill data into dom.

            this.showDialog(context, e);
        },

        save: function () {
            console.log("Save", this);
            return true;
        }
    });


    $class('RegionDialog', Dialog, {
        template:'abmodule/dialog-region',

        show: function (context, e) {
            // TODO: fill data into dom.

            this.showDialog(context, e);
        },

        save: function () {
            console.log("Save", this);
            return true;
        }
    });


</script>