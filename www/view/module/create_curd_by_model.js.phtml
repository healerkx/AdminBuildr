<style>
    .modal.fade.in {
        top: 50%;
    }
</style>
<script>

    function navigateToPreviewTab(data) {
        console.log(data)
        var filesTab = $('table.file-preview tbody');
        var template = $('#files_template');
        var files = data.files;
        for (var i in data.files) {
            var file = files[i];
            var line = $(template).clone().css('display', '');
            line.find('td span').text(file);
            line.appendTo(filesTab)
        }
        $('a[href="#preview"]').click();
    }

    function addFieldInfoRow(fi) {
        var t = $('#fields_action_row_template');

        var tbody = $('#fields_action_table tbody');
        var r = t.clone();
        console.log(t, tbody);
        var fieldName = fi['Field'];
        var fieldType = fi['Type'];
        var fieldComment = fi['Comment'];
        r.attr('field', fieldName).css('display', '').removeAttr('id');
        r.find('td[field=field] span.field_name').text(fieldName);
        r.find('td[field=field] span.field_type').text(fieldType);
        r.find('td[field=field_text] input').val(fieldComment);
        r.find('td[field=field_type] span').text(fieldType);
        r.find('td[field=field_name] span').text(fi['Field']);
        r.find('td[field=field_name] span').text(fi['Field']);
        r.find('td[field=field_name] span').text(fi['Field']);
        r.find('td[field=field_name] span').text(fi['Field']);

        if (fi['Key'] == 'PRI') {
            var modeSelect = r.find('td[field=field_mode] select');
            modeSelect.append('<option value="primaryKey">主键ID</option>')
            modeSelect.val('primaryKey').attr('disabled', 'disabled');
        }

        r.appendTo(tbody);
    }

    function initFieldsConfigList(data) {
        var tbody = $('#fields_action_table tbody');
        tbody.empty();
        console.log(data)
        var fields = data.fields;
        for (var i in fields) {
            var fi = fields[i];
            // console.log(fields[i]);
            addFieldInfoRow(fi);
        }
    }

    function initFieldNameLists(data) {
        var fields = data.fields;
        var commitFieldSelect = $('#commit_field_select');
        var deleteFieldSelect = $('#delete_field_select');
        commitFieldSelect.empty();
        deleteFieldSelect.empty();
        var template = '<option value="{field_name}">{field_name}&nbsp;&nbsp;{field_type}</option>'
        var fieldNameList = [];
        for (var i in fields) {
            var fi = fields[i];
            var fieldName = fi['Field'];
            var fieldType = fi['Type'];
            fieldNameList.push(fieldName);

            var o = template.format({field_name: fieldName, field_type: fieldType});

            var o1 = $(o);
            var o2 = $(o);
            o1.appendTo(commitFieldSelect);
            o2.appendTo(deleteFieldSelect);
        }

    }

    function collectFieldConfig(tr) {
        var fieldName = tr.find('td[field=field] span.field_name').text();
        var fieldMode = tr.find('td[field=field_mode] select').val();
        var fieldText = tr.find('td[field=field_text] input').val();
        var hideInList = tr.find('td[field=hide_in_list] select').val();
        var hideInCreate = tr.find('td[field=hide_in_create] select').val();
        var hideInUpdate = tr.find('td[field=hide_in_update] select').val();

        var o = {
            fieldName: fieldName,
            fieldMode: fieldMode,
            fieldText: fieldText,
            hideInList:hideInList,
            hideInCreate:hideInCreate,
            hideInUpdate:hideInUpdate,
        };
        console.log(o);
        return o;
    }

    function collectFieldsConfig() {
        var info = {
            FieldsConfig:[],
            CommitSupport:{},
            DeleteSupport:{}};
        var trs = $('#fields_action_table tbody tr');

        trs.each(function(index, tr){
            var tr = $(tr);
            var o = collectFieldConfig(tr);
            if (o['fieldMode'] == 'primaryKey') {
                info['PrimaryKey'] = o['fieldName'];
            }
            info['FieldsConfig'].push(o)
        });

        var commitSupportChecked = $('#commit_support').attr('checked');
        info['CommitSupport'].support = 'No';
        if (commitSupportChecked == 'checked') {
            info['CommitSupport'].support = 'Yes';
            info['CommitSupport'].field = $('#commit_field_select').val();
            info['CommitSupport'].value = $('#commit_field_value').val();
        }

        var deleteSupportChecked = $('#delete_support').attr('checked');
        info['DeleteSupport'].support = 'No';
        if (deleteSupportChecked == 'checked') {
            info['DeleteSupport'].support = 'Yes';
            info['DeleteSupport'].field = $('#delete_field_select').val();
            info['DeleteSupport'].value = $('#delete_field_value').val();
        }

        return info;
    }


    $(function(){
        //FormComponents.init();

        $.getJSON('/module/tableNames', function (data) {
            if (data.error == 0) {
                var tableNameSelect = $('#table_name');
                var a = data.data;
                for (var i in a) {
                    var tabName = a[i]['Tables_in_badmin'];

                    var template = "<option value=\"{table_name}\">{table_name}</option>".format({table_name:tabName});
                    console.log(template)
                    var t = $(template).clone();
                    t.appendTo(tableNameSelect);
                }

            }

        });


        $('#load-model-button').click(function(){
            var tableName = $('#table_name').val();
            $.post("/module/info",
                {
                    table:tableName, model:""
                },
                function(data){
                    // console.log(typeof(data));
                    var data = data.toJson();
                    if (data.error == 0) {
                        initFieldsConfigList(data.data);
                        initFieldNameLists(data.data);
                    }
                });
        });

        $('#preview-button').click(function(){
            var info = collectFieldsConfig();
            var prefix = $('#model_prefix').val();
            var tableName = $('#table_name').val();

            $.post("/module/preview",
                {
                    prefix: prefix,
                    table_name: tableName,
                    info: info,
                },
                function(data) {
                    var data = data.toJson();
                    if (data.error == 0) {
                        navigateToPreviewTab(data.data);
                    }
                });
            return false;
        });

    });
</script>
